<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Skrining TBC — SIKAT TB</title>

    <!-- Favicon (added) -->
    <link rel="icon" href="https://raw.githubusercontent.com/TBPKMMULYOREJO/TBPKMMULYOREJO.github.io/refs/heads/main/logo.ico" type="image/x-icon" />
    <link rel="shortcut icon" href="https://raw.githubusercontent.com/TBPKMMULYOREJO/TBPKMMULYOREJO.github.io/refs/heads/main/logo.ico" type="image/x-icon" />

    <style>
        :root {
            --bg: #f4f7fb;
            --card: #fff;
            --accent: #2b7a78;
            --accent-2: #d9534f;
            --muted: #6b7280;
            --radius: 12px;
            --shadow: 0 6px 22px rgba(16, 24, 40, 0.08);
        }
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            background: linear-gradient(180deg, #e8f7f6 0%, var(--bg) 100%);
            font-family: Inter, system-ui, Segoe UI, Roboto, Arial;
            color: #0f172a;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            min-height: 100vh;
        }
        .wrap {
            width: 100%;
            max-width: 820px;
        }
        .card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 28px;
            box-shadow: var(--shadow);
            position: relative;
        }
        header {
            display: flex;
            gap: 16px;
            align-items: center;
            margin-bottom: 18px;
            justify-content: space-between;
        }
        .logo {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--accent), #4aa6a4);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            flex: 0 0 56px;
        }
        h1 {
            font-size: 18px;
            margin: 0;
        }
        p.lead {
            margin: 4px 0 0 0;
            font-size: 13px;
            color: var(--muted);
        }
        .top-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .top-actions button {
            padding: 8px 12px;
            border-radius: 10px;
            border: none;
            background: #f3f4f6;
            cursor: pointer;
            font-weight: 700;
        }
        .top-actions button.active {
            background: var(--accent);
            color: white;
        }
        .step-labels {
            display: flex;
            gap: 10px;
            justify-content: space-between;
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 8px;
        }
        .progress {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }
        .step {
            flex: 1;
            height: 10px;
            background: #eef2f5;
            border-radius: 10px;
            overflow: hidden;
        }
        .bar {
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, var(--accent), #4aa6a4);
            transition: width 0.35s;
        }
        form .section {
            display: none;
        }
        form .section.active {
            display: block;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 12px;
        }
        label {
            font-weight: 600;
            font-size: 13px;
        }
        input,
        textarea,
        select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e6e9ee;
            font-size: 14px;
        }
        textarea {
            min-height: 90px;
            resize: vertical;
        }
        .full {
            grid-column: 1 / -1;
        }
        .choices {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .chip {
            padding: 8px 12px;
            border-radius: 999px;
            border: 1px solid #e6e9ee;
            background: #fff;
            cursor: pointer;
        }
        .chip.active {
            background: var(--accent);
            color: #fff;
            border-color: transparent;
            box-shadow: 0 6px 16px rgba(43, 122, 120, 0.14);
        }
        .buttons {
            display: flex;
            gap: 12px;
            justify-content: space-between;
            margin-top: 16px;
            align-items: center;
        }
        .btn {
            padding: 10px 14px;
            border-radius: 10px;
            border: none;
            font-weight: 700;
            cursor: pointer;
        }
        .btn.secondary {
            background: #f3f4f6;
            color: #111;
            border: 1px solid #e6e9ee;
        }
        .btn.primary {
            background: var(--accent);
            color: #fff;
            box-shadow: 0 8px 26px rgba(43, 122, 120, 0.14);
        }
        .btn.warn {
            background: var(--accent-2);
            color: #fff;
        }
        .note {
            font-size: 13px;
            color: var(--muted);
        }
        .message {
            display: none;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-weight: 600;
        }
        .message.show {
            display: block;
        }
        .message.success {
            background: #ecf9f6;
            color: #0b5b53;
        }
        .message.error {
            background: #fff3f2;
            color: #7a271f;
        }
        footer {
            margin-top: 10px;
            font-size: 12px;
            color: var(--muted);
            text-align: center;
        }

        /* Results panel */
        #resultsPanel {
            display: none;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #eef2f5;
            background: #fbfeff;
            margin-top: 12px;
        }
        #resultsPanel h3 {
            margin-top: 0;
        }
        .kv {
            display: flex;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px dashed #eef2f5;
        }
        .kv:last-child {
            border-bottom: none;
        }
        .kv .k {
            width: 40%;
            color: var(--muted);
            font-weight: 600;
        }
        .kv .v {
            width: 60%;
        }

        /* Modal */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(10, 12, 14, 0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 40;
        }
        .modal {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 520px;
            width: 92%;
            box-shadow: 0 12px 40px rgba(2, 6, 23, 0.35);
        }
        .modal h2 {
            margin: 0 0 8px 0;
        }
        .modal .modal-body {
            margin-top: 12px;
        }
        .modal .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 18px;
        }
        .modal .thanks {
            background: #ecf9f6;
            padding: 10px;
            border-radius: 8px;
            color: #0b5b53;
            margin-top: 12px;
            font-weight: 700;
        }

        @media (max-width: 720px) {
            .grid {
                grid-template-columns: 1fr;
            }
            .logo {
                width: 48px;
                height: 48px;
            }
        }
    </style>

    <!-- EmailJS SDK (client-side) -->
    <script
            type="text/javascript"
            src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"
    ></script>
</head>
<body>
<div class="wrap">
    <div class="card" role="main" aria-labelledby="title">
        <header>
          <div style="display: flex; gap: 16px; align-items: center">
            <div class="logo" aria-hidden="true">
              <!-- Replaced inline SVG with external logo.svg -->
              <img
                src="https://raw.githubusercontent.com/TBPKMMULYOREJO/TBPKMMULYOREJO.github.io/520d44136548ce71999be4557c5d9fdb7c3dee0d/logo.svg"
                alt="SIKAT TB logo"
                style="width:36px;height:36px;object-fit:contain;display:block"
                aria-hidden="true"
              />
            </div>
            <div>
              <h1 id="title">SIKAT TB</h1>
              <p class="lead">Skrining Cepat Atasi TBC</p>
            </div>
          </div>

            <div class="top-actions" aria-hidden="true">
                <button id="viewFormBtn" class="active">Form</button>
                <button id="viewResultsBtn">Hasil</button>
            </div>
        </header>

        <div class="step-labels" aria-hidden="true">
            <span>Data Diri</span><span>Keluhan yang Dirasakan</span><span>Informasi Lain</span>
        </div>
        <div class="progress" aria-hidden="true">
            <div class="step">
                <div class="bar" data-step="0" style="width: 100%"></div>
            </div>
            <div class="step"><div class="bar" data-step="1"></div></div>
            <div class="step"><div class="bar" data-step="2"></div></div>
        </div>

        <!-- Main Form -->
        <form id="tbForm" autocomplete="off">
            <input type="hidden" id="exam_date" name="exam_date" readonly />
            <section class="section active" data-index="0" aria-label="Data Diri">
                <div class="grid">
                    <div class="field full">
                        <label for="name"
                        >Nama Lengkap <span style="color: #d9534f">*</span></label
                        ><input
                            id="name"
                            name="name"
                            type="text"
                            required
                            placeholder="Nama pasien"
                    />
                    </div>
                    <div class="field">
                        <label for="age"
                        >Usia (tahun) <span style="color: #d9534f">*</span></label
                        ><input
                            id="age"
                            name="age"
                            type="number"
                            min="0"
                            required
                            placeholder="35"
                    />
                    </div>
                    <div class="field">
                        <label for="weight">Berat Badan (kg) <span style="color: #d9534f">*</span></label
                        ><input
                            id="weight"
                            name="weight"
                            type="number"
                    />
                    </div>
                    <div class="field">
                        <label for="height">Tinggi Badan (cm) <span style="color: #d9534f">*</span></label
                        ><input
                            id="height"
                            name="height"
                            type="number"
                    />
                    </div>
                    <div class="field">
                        <label for="gender"
                        >Jenis Kelamin <span style="color: #d9534f">*</span></label
                        ><select id="gender" name="gender" required>
                        <option value="">Pilih</option>
                        <option value="Laki-laki">Laki-laki</option>
                        <option value="Perempuan">Perempuan</option>
                    </select>
                    </div>
                    <div class="field">
                        <label for="phone">Nomor Telepon</label
                        ><input
                            id="phone"
                            name="phone"
                            type="tel"
                            placeholder="+62..."
                    />
                    </div>
                    <div class="field">
                        <label for="job">Pekerjaan <span style="color: #d9534f">*</span></label
                        ><input
                            id="job"
                            name="job"
                            type="text"
                    />
                    </div>
                    <div class="field full">
                        <label for="address">Alamat Domisili <span style="color: #d9534f">*</span></label
                        ><input
                            id="address"
                            name="address"
                            type="text"
                    />
                    </div>
                    <div class="field">
                        <label for="location"
                        >Posyandu Keluarga (Posga) <span style="color: #d9534f">*</span></label
                        ><select id="location" name="location" required>
                        <option value="">Pilih</option>
                        <option value="Melati 2">Melati 2 Mulyorejo</option>
                        <option value="Anggrek 1">Anggrek 1 Mulyorejo</option>
                        <option value="Melati 3">Melati 3 Mulyorejo</option>
                        <option value="Anggrek 2">Anggrek 2 Mulyorejo</option>
                        <option value="Mawar 1">Mawar 1 Mulyorejo</option>
                        <option value="Melati 1">Melati 1 Mulyorejo</option>
                        <option value="Mawar 2">Mawar 2 Mulyorejo</option>
                        <option value="Anggrek 3">Anggrek 3 Mulyorejo</option>
                        <option value="Mekarsari">Mekarsari Mulyorejo</option>
                        <option value="Dahlia III">Dahlia III Manyar Sabrangan</option>
                        <option value="Melati v">Melati V Manyar Sabrangan</option>
                        <option value="Dahlia I">Dahlia I Manyar Sabrangan</option>
                        <option value="Melati III">Melati III Manyar Sabrangan</option>
                        <option value="Flamboyan I">Flamboyan I Manyar Sabrangan</option>
                        <option value="Flamboyan II">Flamboyan II Manyar Sabrangan</option>
                        <option value="Asparagus II">Asparagus II Manyar Sabrangan</option>
                        <option value="Dahlia II">Dahlia II Manyar Sabrangan</option>
                        <option value="Melati I">Melati I Manyar Sabrangan</option>
                        <option value="Melati II">Melati II Manyar Sabrangan</option>
                        <option value="Dahlia V">Dahlia V Manyar Sabrangan</option>
                        <option value="Dahlia IV">Dahlia IV Manyar Sabrangan</option>
                        <option value="Dahlia VI">Dahlia VI Manyar Sabrangan</option>
                        <option value="Asparagus I">Asparagus I Manyar Sabrangan</option>
                        <option value="Mawar III">Mawar III Manyar Sabrangan</option>
                        <option value="Mawar I">Mawar I Manyar Sabrangan</option>
                        <option value="Mawar II">Mawar II Manyar Sabrangan</option>
                        <option value="Mawar IV">Mawar IV Manyar Sabrangan</option>
                        <option value="Melati IV">Melati IV Manyar Sabrangan</option>
                        <option value="Berlian P">Berlian P Kejawan Putih Tambak</option>
                        <option value="Intan P">Intan P Kejawan Putih Tambak</option>
                        <option value="Melati P">Melati P Kejawan Putih Tambak</option>
                        <option value="Mawar P">Mawar P Kejawan Putih Tambak</option>
                        <option value="Delima">Delima Kejawan Putih Tambak</option>
                        <option value="Permata P">Permata P Kejawan Putih Tambak</option>
                    </select>
                    </div>
                </div>
                <p class="note">Kolom bertanda * wajib diisi.</p>
            </section>

            <section class="section" data-index="1" aria-label="Keluhan yang dirasakan">
                <div class="questions-grid">
                    <div class="field">
                        <label>Batuk > 2 minggu <span style="color: #d9534f">*</span></label>
                        <div class="choices">
                            <button
                                    type="button"
                                    class="chip"
                                    data-name="cough_long"
                                    data-value="Ya"
                            >
                                Ya</button
                            ><button
                                type="button"
                                class="chip"
                                data-name="cough_long"
                                data-value="Tidak"
                        >
                            Tidak
                        </button>
                        </div>
                    </div>
                    <div class="field">
                        <label>Demam hilang timbul tanpa sebab yang jelas <span style="color: #d9534f">*</span></label>
                        <div class="choices">
                            <button
                                    type="button"
                                    class="chip"
                                    data-name="fever"
                                    data-value="Ya"
                            >
                                Ya</button
                            ><button
                                type="button"
                                class="chip"
                                data-name="fever"
                                data-value="Tidak"
                        >
                            Tidak
                        </button>
                        </div>
                    </div>
                    <div class="field">
                        <label>Berkeringat di malam hari tanpa aktivitas <span style="color: #d9534f">*</span></label>
                        <div class="choices">
                            <button
                                    type="button"
                                    class="chip"
                                    data-name="night_sweats"
                                    data-value="Ya"
                            >
                                Ya</button
                            ><button
                                type="button"
                                class="chip"
                                data-name="night_sweats"
                                data-value="Tidak"
                        >
                            Tidak
                        </button>
                        </div>
                    </div>
                    <div class="field">
                        <label>Sesak nafas <span style="color: #d9534f">*</span></label>
                        <div class="choices">
                            <button
                                    type="button"
                                    class="chip"
                                    data-name="shortness_of_breath"
                                    data-value="Ya"
                            >
                                Ya</button
                            ><button
                                type="button"
                                class="chip"
                                data-name="shortness_of_breath"
                                data-value="Tidak"
                        >
                            Tidak
                        </button>
                        </div>
                    </div>
                    <div class="field">
                        <label>Nyeri dada <span style="color: #d9534f">*</span></label>
                        <div class="choices">
                            <button
                                    type="button"
                                    class="chip"
                                    data-name="chest_pain"
                                    data-value="Ya"
                            >
                                Ya</button
                            ><button
                                type="button"
                                class="chip"
                                data-name="chest_pain"
                                data-value="Tidak"
                        >
                            Tidak
                        </button>
                        </div>
                    </div>
                    <div class="field">
                        <label>Ada benjolan di leher/bawah rahang/bawah telinga/ketiak <span style="color: #d9534f">*</span></label>
                        <div class="choices">
                            <button
                                    type="button"
                                    class="chip"
                                    data-name="lymph_swelling"
                                    data-value="Ya"
                            >
                                Ya</button
                            ><button
                                type="button"
                                class="chip"
                                data-name="lymph_swelling"
                                data-value="Tidak"
                        >
                            Tidak
                        </button>
                        </div>
                    </div>
                    <div class="field">
                        <label>Batuk berdarah <span style="color: #d9534f">*</span></label>
                        <div class="choices">
                            <button
                                    type="button"
                                    class="chip"
                                    data-name="cough_blood"
                                    data-value="Ya"
                            >
                                Ya</button
                            ><button
                                type="button"
                                class="chip"
                                data-name="cough_blood"
                                data-value="Tidak"
                        >
                            Tidak
                        </button>
                        </div>
                    </div>
                    <div class="field">
                        <label>Batuk kurang dari 2 minggu <span style="color: #d9534f">*</span></label>
                        <div class="choices">
                            <button
                                    type="button"
                                    class="chip"
                                    data-name="cough_short"
                                    data-value="Ya"
                            >
                                Ya</button
                            ><button
                                type="button"
                                class="chip"
                                data-name="cough_short"
                                data-value="Tidak"
                        >
                            Tidak
                        </button>
                        </div>
                    </div>
                    <div class="field">
                        <label>Nafsu makan turun (hilang nafsu makan selama berhari-hari) <span style="color: #d9534f">*</span></label>
                        <div class="choices">
                            <button
                                    type="button"
                                    class="chip"
                                    data-name="appetite_loss"
                                    data-value="Ya"
                            >
                                Ya</button
                            ><button
                                type="button"
                                class="chip"
                                data-name="appetite_loss"
                                data-value="Tidak"
                        >
                            Tidak
                        </button>
                        </div>
                    </div>
                    <div class="field">
                        <label>Mudah lelah (sering kecapekan tanpa aktivitas fisik yang berarti) <span style="color: #d9534f">*</span></label>
                        <div class="choices">
                            <button
                                    type="button"
                                    class="chip"
                                    data-name="fatigue"
                                    data-value="Ya"
                            >
                                Ya</button
                            ><button
                                type="button"
                                class="chip"
                                data-name="fatigue"
                                data-value="Tidak"
                        >
                            Tidak
                        </button>
                        </div>
                    </div>
                    <div class="field">
                        <label>Berat badan turun (turun drastis berhari-hari bukan karena diet) <span style="color: #d9534f">*</span></label>
                        <div class="choices">
                            <button
                                    type="button"
                                    class="chip"
                                    data-name="weight_loss"
                                    data-value="Ya"
                            >
                                Ya</button
                            ><button
                                type="button"
                                class="chip"
                                data-name="weight_loss"
                                data-value="Tidak"
                        >
                            Tidak
                        </button>
                        </div>
                    </div>
                </div>
            </section>

            <section class="section" data-index="2" aria-label="Informasi Lain">
                <div class="questions-grid">
                    <div class="field full">
                        <label>Anggota keluarga serumah ada yang sakit TBC? <span style="color: #d9534f">*</span></label>
                        <div class="choices">
                            <button
                                    type="button"
                                    class="chip"
                                    data-name="tb_contact"
                                    data-value="Ya"
                            >
                                Ya</button
                            ><button
                                type="button"
                                class="chip"
                                data-name="tb_contact"
                                data-value="Tidak"
                        >
                            Tidak
                        </button>
                        </div>
                    </div>
                    <div class="field full">
                        <label>Pernah berada satu ruangan dengan penderita TBC (di tempat kerja/kelas/kamar/asrama/panti/barak, dll) <span style="color: #d9534f">*</span></label>
                        <div class="choices">
                            <button
                                    type="button"
                                    class="chip"
                                    data-name="tb_close_contact"
                                    data-value="Ya"
                            >
                                Ya</button
                            ><button
                                type="button"
                                class="chip"
                                data-name="tb_close_contact"
                                data-value="Tidak"
                        >
                            Tidak
                        </button>
                        </div>
                    </div>
                    <div class="field full">
                        <label>Apakah pernah tinggal serumah minimal satu malam atau sering tinggal serumah pada siang hari dengan orang yang sakit TBC? <span style="color: #d9534f">*</span></label>
                        <div class="choices">
                            <button
                                    type="button"
                                    class="chip"
                                    data-name="tb_household_contact"
                                    data-value="Ya"
                            >
                                Ya</button
                            ><button
                                type="button"
                                class="chip"
                                data-name="tb_household_contact"
                                data-value="Tidak"
                        >
                            Tidak
                        </button>
                        </div>
                    </div>
                    <div class="field full">
                        <label>Pernah berobat TBC tuntas <span style="color: #d9534f">*</span></label>
                        <div class="choices">
                            <button
                                    type="button"
                                    class="chip"
                                    data-name="tb_treatment_complete"
                                    data-value="Ya"
                            >
                                Ya</button
                            ><button
                                type="button"
                                class="chip"
                                data-name="tb_treatment_complete"
                                data-value="Tidak"
                        >
                            Tidak
                        </button>
                        </div>
                    </div>
                    <div class="field full">
                        <label>Pernah berobat TBC tapi tidak tuntas <span style="color: #d9534f">*</span></label>
                        <div class="choices">
                            <button
                                    type="button"
                                    class="chip"
                                    data-name="tb_treatment_incomplete"
                                    data-value="Ya"
                            >
                                Ya</button
                            ><button
                                type="button"
                                class="chip"
                                data-name="tb_treatment_incomplete"
                                data-value="Tidak"
                        >
                            Tidak
                        </button>
                        </div>
                    </div>
                    <div class="field full">
                        <label>Punya riwayat diabetes melitus/kencing manis <span style="color: #d9534f">*</span></label>
                        <div class="choices">
                            <button
                                    type="button"
                                    class="chip"
                                    data-name="diabetes"
                                    data-value="Ya"
                            >
                                Ya</button
                            ><button
                                type="button"
                                class="chip"
                                data-name="diabetes"
                                data-value="Tidak"
                        >
                            Tidak
                        </button>
                        </div>
                    </div>
                    <div class="field full">
                        <label>Orang dengan HIV <span style="color: #d9534f">*</span></label>
                        <div class="choices">
                            <button
                                    type="button"
                                    class="chip"
                                    data-name="hiv_status"
                                    data-value="Ya"
                            >
                                Ya</button
                            ><button
                                type="button"
                                class="chip"
                                data-name="hiv_status"
                                data-value="Tidak"
                        >
                            Tidak
                        </button>
                        </div>
                    </div>
                    <div class="field full">
                        <label>Ibu hamil <span style="color: #d9534f">*</span></label>
                        <div class="choices">
                            <button
                                    type="button"
                                    class="chip"
                                    data-name="pregnant"
                                    data-value="Ya"
                            >
                                Ya</button
                            ><button
                                type="button"
                                class="chip"
                                data-name="pregnant"
                                data-value="Tidak"
                        >
                            Tidak
                        </button>
                        </div>
                    </div>
                    <div class="field full">
                        <label>Merokok <span style="color: #d9534f">*</span></label>
                        <div class="choices">
                            <button
                                    type="button"
                                    class="chip"
                                    data-name="smoking"
                                    data-value="Ya"
                            >
                                Ya</button
                            ><button
                                type="button"
                                class="chip"
                                data-name="smoking"
                                data-value="Tidak"
                        >
                            Tidak
                        </button>
                        </div>
                    </div>
                    <div class="field full">
                        <label>Usia 0-14 tahun <span style="color: #d9534f">*</span></label>
                        <div class="choices">
                            <button
                                    type="button"
                                    class="chip"
                                    data-name="age_0_14"
                                    data-value="Ya"
                            >
                                Ya</button
                            ><button
                                type="button"
                                class="chip"
                                data-name="age_0_14"
                                data-value="Tidak"
                        >
                            Tidak
                        </button>
                        </div>
                    </div>
                    <div class="field full">
                        <label>Lansia (di atas 60 tahun) <span style="color: #d9534f">*</span></label>
                        <div class="choices">
                            <button
                                    type="button"
                                    class="chip"
                                    data-name="elderly_60_plus"
                                    data-value="Ya"
                            >
                                Ya</button
                            ><button
                                type="button"
                                class="chip"
                                data-name="elderly_60_plus"
                                data-value="Tidak"
                        >
                            Tidak
                        </button>
                        </div>
                    </div>
                    <div class="field full">
                        <label>Apakah jendela rumah dibuka setiap hari untuk sirkulasi udara? <span style="color: #d9534f">*</span></label>
                        <div class="choices">
                            <button
                                    type="button"
                                    class="chip"
                                    data-name="window_ventilation"
                                    data-value="Ya"
                            >
                                Ya</button
                            ><button
                                type="button"
                                class="chip"
                                data-name="window_ventilation"
                                data-value="Tidak"
                        >
                            Tidak
                        </button>
                        </div>
                    </div>
                    <div class="field full">
                        <label>Berapa orang tidur dalam satu kamar? <span style="color: #d9534f">*</span></label>
                        <select id="people_sleeping_per_room" name="people_sleeping_per_room" required>
                            <option value="">Pilih</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3 atau lebih">3 atau lebih</option>
                        </select>
                    </div>
                    <div class="field full">
                        <label>Apakah ada bagian rumah yang lembap atau berjamur (tembok hitam/cat mengelupas) <span style="color: #d9534f">*</span></label>
                        <div class="choices">
                            <button
                                    type="button"
                                    class="chip"
                                    data-name="damp_or_mold"
                                    data-value="Ya"
                            >
                                Ya</button
                            ><button
                                type="button"
                                class="chip"
                                data-name="damp_or_mold"
                                data-value="Tidak"
                        >
                            Tidak
                        </button>
                        </div>
                    </div>
                    <div class="field full">
                        <label>Apakah ada penghuni rumah yang merokok di dalam rumah? <span style="color: #d9534f">*</span></label>
                        <div class="choices">
                            <button
                                    type="button"
                                    class="chip"
                                    data-name="indoor_smoking"
                                    data-value="Ya"
                            >
                                Ya</button
                            ><button
                                type="button"
                                class="chip"
                                data-name="indoor_smoking"
                                data-value="Tidak"
                        >
                            Tidak
                        </button>
                        </div>
                    </div>
                    <div class="field full">
                        <label>Apakah ada anggota keluarga yang tidur di ruangan tanpa jendela? <span style="color: #d9534f">*</span></label>
                        <div class="choices">
                            <button
                                    type="button"
                                    class="chip"
                                    data-name="no_window_sleeping"
                                    data-value="Ya"
                            >
                                Ya</button
                            ><button
                                type="button"
                                class="chip"
                                data-name="no_window_sleeping"
                                data-value="Tidak"
                        >
                            Tidak
                        </button>
                        </div>
                    </div>
                </div>
            </section>

            <div class="buttons" role="group" aria-label="Navigasi">
                <button
                        type="button"
                        class="btn secondary"
                        id="btnBack"
                        style="visibility: hidden"
                >
                    ← Kembali
                </button>
                <div style="flex: 1"></div>
                <button type="button" class="btn warn" id="btnSaveDraft">
                    Simpan Draft
                </button>
                <button type="button" class="btn primary" id="btnNext">
                    Selanjutnya →
                </button>
            </div>

            <div id="message" class="message"></div>
        </form>

        <!-- Results Panel (accessible via header 'Hasil' button) -->
        <div id="resultsPanel" aria-live="polite">
            <h3>Ringkasan Pengisian Terakhir</h3>
            <div id="resultsContent">
                <p class="note">
                    Belum ada data. Setelah submit, ringkasan akan muncul di sini.
                </p>
            </div>
            <div
                    style="display: flex; justify-content: flex-end; margin-top: 12px"
            >
                <button id="backToFormFromResults" class="btn primary">
                    Kembali ke Form
                </button>
            </div>
        </div>

        <footer>
            SIKAT TBC (Skrining Cepat Atasi TBC)
        </footer>
    </div>
</div>

<!-- Hidden iframe dan form (dipakai untuk mengirim ke Google Apps Script tanpa preflight) -->
<iframe name="gs-iframe" id="gs-iframe" style="display: none"></iframe>
<form
        id="gs-hidden-form"
        action=""
        method="post"
        target="gs-iframe"
        style="display: none"
>
    <input type="hidden" name="sheetName" value="TB_Screening" />
    <input type="hidden" name="values" value="" />
</form>

<!-- Modal summary -->
<div
        class="modal-backdrop"
        id="modalBackdrop"
        role="dialog"
        aria-modal="true"
        aria-hidden="true"
>
    <div class="modal" id="modal">
        <h2>Terima kasih — Ringkasan Pengisian</h2>
        <div class="modal-body" id="modalBody">
            <!-- summary filled dynamically -->
        </div>
        <div class="thanks" id="modalThanks">
            Terima kasih sudah berpartisipasi mengisi form skrining TBC.
        </div>
        <div class="modal-actions">
            <button id="modalClose" class="btn secondary">Tutup</button>
            <button id="modalViewResults" class="btn primary">
                Lihat Ringkasan
            </button>
        </div>
    </div>
</div>

<script>
    // CONFIG: ganti jika perlu
    const googleAppsScriptUrl =
        "https://script.google.com/macros/s/AKfycbzA-fQ4nUrsDuhl07MPypboYtGRqWailTy1emKckmbUopgB1En8V9TAO4t0fqCkEnh1/exec";
    const sheetName = "TB_Screening";

    // EMAILJS CONFIG - ganti dengan nilai Anda
    emailjs.init("wcIKSqvFvWJneAHIm");
    const EMAIL_RECIPIENT = "imfeshika@gmail.com"; // tujuan email (yang Anda minta)

    // UI elements
    const sections = Array.from(document.querySelectorAll(".section"));
    const bars = Array.from(document.querySelectorAll(".bar"));
    const btnNext = document.getElementById("btnNext");
    const btnBack = document.getElementById("btnBack");
    const btnSaveDraft = document.getElementById("btnSaveDraft");
    const msgBox = document.getElementById("message");
    const examDate = document.getElementById("exam_date");
    const hiddenForm = document.getElementById("gs-hidden-form");
    const hiddenValuesInput = hiddenForm.querySelector(
        'input[name="values"]'
    );
    hiddenForm.action = googleAppsScriptUrl;

    const viewFormBtn = document.getElementById("viewFormBtn");
    const viewResultsBtn = document.getElementById("viewResultsBtn");
    const resultsPanel = document.getElementById("resultsPanel");
    const resultsContent = document.getElementById("resultsContent");
    const backToFormFromResults = document.getElementById(
        "backToFormFromResults"
    );

    // modal
    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalBody = document.getElementById("modalBody");
    const modalClose = document.getElementById("modalClose");
    const modalViewResults = document.getElementById("modalViewResults");

    let current = 0;

    function setExamDate() {
        const d = new Date();
        examDate.value = d.toISOString().split("T")[0];
    }

    function showMessage(text, type = "success") {
        msgBox.textContent = text;
        msgBox.className = `message show ${
            type === "success" ? "success" : "error"
        }`;
        setTimeout(() => msgBox.classList.remove("show"), 3500);
    }

    function showStep(i) {
        sections.forEach((s) => s.classList.remove("active"));
        sections[i].classList.add("active");
        bars.forEach((b, idx) => (b.style.width = idx <= i ? "100%" : "0%"));
        btnBack.style.visibility = i === 0 ? "hidden" : "visible";
        btnNext.textContent =
            i === sections.length - 1 ? "Kirim" : "Selanjutnya →";
        // ensure results panel hidden when navigating form
        hideResultsPanel();
        setActiveTopAction("form");
    }

    // chips behavior
    document.querySelectorAll(".chip").forEach((chip) => {
        chip.addEventListener("click", () => {
            const name = chip.dataset.name;
            document
                .querySelectorAll(`.chip[data-name="${name}"]`)
                .forEach((c) => c.classList.remove("active"));
            chip.classList.add("active");
        });
    });

    btnNext.addEventListener("click", () => {
        if (current < sections.length - 1) {
            if (!validateSection(current)) return;
            current++;
            showStep(current);
        } else {
            if (!validateSection(current)) return;
            submitViaIframe();
        }
    });

    btnBack.addEventListener("click", () => {
        if (current > 0) {
            current--;
            showStep(current);
        }
    });

    btnSaveDraft.addEventListener("click", () => {
        const data = gatherData();
        localStorage.setItem("tb_form_draft", JSON.stringify(data));
        showMessage("Draft disimpan secara lokal", "success");
    });

    document.addEventListener("DOMContentLoaded", () => {
        setExamDate();
        setReportDateInputs();
        const draft = localStorage.getItem("tb_form_draft");
        if (draft) {
            try {
                restoreDraft(JSON.parse(draft));
            } catch (e) {}
        }
        showStep(current);
        // top actions
        viewFormBtn.addEventListener("click", () => {
            hideResultsPanel();
            setActiveTopAction("form");
        });
        viewResultsBtn.addEventListener("click", () => {
            showResultsPanel();
            setActiveTopAction("results");
        });
        backToFormFromResults.addEventListener("click", () => {
            hideResultsPanel();
            setActiveTopAction("form");
        });
        // modal actions
        modalClose.addEventListener("click", () => hideModal());
        modalViewResults.addEventListener("click", () => {
            hideModal();
            showResultsPanel();
            setActiveTopAction("results");
        });
    });

    function setReportDateInputs() {
        const iso = new Date().toISOString().split("T")[0];
        document.querySelectorAll("input[readonly]").forEach((i) => {
            if (i.name === "exam_date") i.value = iso;
        });
    }

    function validateSection(idx) {
        const sec = sections[idx];
        const reqs = sec.querySelectorAll(
            "input[required], select[required], textarea[required]"
        );
        for (const el of reqs) {
            if (!el.value || el.value.trim() === "") {
                el.focus();
                showMessage("Mohon lengkapi kolom yang wajib diisi.", "error");
                return false;
            }
        }
        return true;
    }

    function gatherData() {
        const fd = new FormData(document.getElementById("tbForm"));
        const chipGroups = {};
        document.querySelectorAll(".chip.active").forEach((c) => {
            chipGroups[c.dataset.name] = c.dataset.value;
        });
        const data = {
            timestamp: new Date().toLocaleString(),
            exam_date: fd.get("exam_date") || "",
            name: (fd.get("name") || "").trim(),
            age: fd.get("age") || "",
            weight: fd.get("weight") || "",
            height: fd.get("height") || "",
            gender: fd.get("gender") || "",
            phone: fd.get("phone") || "",
            job: fd.get("job") || "",
            address: fd.get("address") || "",
            location: fd.get("location") || "",
            // Keluhan (section 2)
            cough_long: chipGroups["cough_long"] || "",
            cough_short: chipGroups["cough_short"] || "",
            cough_blood: chipGroups["cough_blood"] || "",
            fever: chipGroups["fever"] || "",
            night_sweats: chipGroups["night_sweats"] || "",
            shortness_of_breath: chipGroups["shortness_of_breath"] || "",
            chest_pain: chipGroups["chest_pain"] || "",
            lymph_swelling: chipGroups["lymph_swelling"] || "",
            appetite_loss: chipGroups["appetite_loss"] || "",
            fatigue: chipGroups["fatigue"] || "",
            weight_loss: chipGroups["weight_loss"] || "",
            // Informasi lain (section 3)
            tb_contact: chipGroups["tb_contact"] || "",
            tb_close_contact: chipGroups["tb_close_contact"] || "",
            tb_household_contact: chipGroups["tb_household_contact"] || "",
            tb_treatment_complete: chipGroups["tb_treatment_complete"] || "",
            tb_treatment_incomplete: chipGroups["tb_treatment_incomplete"] || "",
            diabetes: chipGroups["diabetes"] || "",
            hiv_status: chipGroups["hiv_status"] || "",
            pregnant: chipGroups["pregnant"] || "",
            smoking: chipGroups["smoking"] || "",
            age_0_14: chipGroups["age_0_14"] || "",
            elderly_60_plus: chipGroups["elderly_60_plus"] || "",
            window_ventilation: chipGroups["window_ventilation"] || "",
            people_sleeping_per_room:
                fd.get("people_sleeping_per_room") || "",
            damp_or_mold: chipGroups["damp_or_mold"] || "",
            indoor_smoking: chipGroups["indoor_smoking"] || "",
            no_window_sleeping: chipGroups["no_window_sleeping"] || "",
            // legacy/optional fields (if present)
            complaint: fd.get("complaint") || "",
            severity: fd.get("severity") || "",
            other_symptoms: fd.get("other_symptoms") || "",
        };
        return data;
    }

    function restoreDraft(obj) {
        try {
            if (!obj) return;
            if (obj.name) document.getElementById("name").value = obj.name;
            if (obj.age) document.getElementById("age").value = obj.age;
            if (obj.weight) document.getElementById("weight").value = obj.weight;
            if (obj.height) document.getElementById("height").value = obj.height;
            if (obj.gender) document.getElementById("gender").value = obj.gender;
            if (obj.phone) document.getElementById("phone").value = obj.phone;
            if (obj.job) document.getElementById("job").value = obj.job;
            if (obj.location) document.getElementById("location").value = obj.location;
            if (obj.address) document.getElementById("address").value = obj.address;
            if (obj.complaint) document.getElementById("complaint").value = obj.complaint;
            if (obj.severity) document.getElementById("severity").value = obj.severity;
            if (obj.other_symptoms)
                document.getElementById("other_symptoms").value = obj.other_symptoms;
            if (obj.people_sleeping_per_room)
                document.getElementById("people_sleeping_per_room").value =
                    obj.people_sleeping_per_room;

            // restore chips for all question keys used in gatherData (section 2 & 3)
            const chipKeys = [
                // Section 2 (Keluhan)
                "cough_long",
                "cough_short",
                "cough_blood",
                "fever",
                "night_sweats",
                "shortness_of_breath",
                "chest_pain",
                "lymph_swelling",
                "appetite_loss",
                "fatigue",
                "weight_loss",
                // Section 3 (Informasi Lain)
                "tb_contact",
                "tb_close_contact",
                "tb_household_contact",
                "tb_treatment_complete",
                "tb_treatment_incomplete",
                "diabetes",
                "hiv_status",
                "pregnant",
                "smoking",
                "age_0_14",
                "elderly_60_plus",
                "window_ventilation",
                "damp_or_mold",
                "indoor_smoking",
                "no_window_sleeping"
            ];

            chipKeys.forEach((name) => {
                if (obj[name]) {
                    const el = document.querySelector(
                        `.chip[data-name="${name}"][data-value="${obj[name]}"]`
                    );
                    if (el) el.classList.add("active");
                }
            });
        } catch (e) {
            // ignore restore errors
        }
    }

    function renderSummaryHTML(data) {
        const rows = [
            ["Waktu", data.timestamp || ""],
            ["Tanggal Pemeriksaan", data.exam_date || ""],
            ["Nama", data.name || ""],
            ["Usia (tahun)", data.age || ""],
            ["Berat badan (kg)", data.weight || ""],
            ["Tinggi badan (cm)", data.height || ""],
            ["Jenis Kelamin", data.gender || ""],
            ["Nomor Telepon", data.phone || ""],
            ["Pekerjaan", data.job || ""],
            ["Alamat Domisili", data.address || ""],
            ["Posyandu / Lokasi", data.location || ""],
            // Section 2 - Keluhan
            ["Batuk > 2 minggu", data.cough_long || ""],
            ["Batuk < 2 minggu", data.cough_short || ""],
            ["Batuk berdarah", data.cough_blood || ""],
            ["Demam", data.fever || ""],
            ["Keringat malam tanpa aktivitas", data.night_sweats || ""],
            ["Sesak napas", data.shortness_of_breath || ""],
            ["Nyeri dada", data.chest_pain || ""],
            ["Benjolan di leher/rahang/telinga/ketiak", data.lymph_swelling || ""],
            ["Nafsu makan turun", data.appetite_loss || ""],
            ["Mudah lelah", data.fatigue || ""],
            ["Berat badan turun", data.weight_loss || ""],
            // Section 3 - Informasi lain
            ["Anggota keluarga sakit TBC", data.tb_contact || ""],
            ["Pernah berada satu ruangan dengan penderita TBC", data.tb_close_contact || ""],
            ["Tinggal serumah/sering dengan penderita TBC", data.tb_household_contact || ""],
            ["Pernah berobat TBC tuntas", data.tb_treatment_complete || ""],
            ["Pernah berobat TBC tidak tuntas", data.tb_treatment_incomplete || ""],
            ["Riwayat diabetes", data.diabetes || ""],
            ["Orang dengan HIV", data.hiv_status || ""],
            ["Ibu hamil", data.pregnant || ""],
            ["Merokok", data.smoking || ""],
            ["Usia 0-14 tahun", data.age_0_14 || ""],
            ["Lansia (>60 tahun)", data.elderly_60_plus || ""],
            ["Jendela rumah dibuka setiap hari", data.window_ventilation || ""],
            ["Orang tidur per kamar", data.people_sleeping_per_room || ""],
            ["Rumah lembap/berjamur", data.damp_or_mold || ""],
            ["Ada yang merokok di dalam rumah", data.indoor_smoking || ""],
            ["Ada penghuni tidur di ruangan tanpa jendela", data.no_window_sleeping || ""],
            // Legacy / optional
            ["Keluhan (opsional)", data.complaint || ""],
            ["Tingkat keparahan (opsional)", data.severity || ""],
            ["Gejala lain (opsional)", data.other_symptoms || ""]
        ];
        // hanya tampilkan kesimpulan di modal: "Teduga TBC" jika ada >=1 "Ya" di section Keluhan
        const symptomKeys = [
            "cough_long",
            "cough_short",
            "cough_blood",
            "fever",
            "night_sweats",
            "shortness_of_breath",
            "chest_pain",
            "lymph_swelling",
            "appetite_loss",
            "fatigue",
            "weight_loss",
        ];
        const yesCount = symptomKeys.reduce(
            (acc, k) => acc + (data[k] === "Ya" ? 1 : 0),
            0
        );
        const conclusion = yesCount >= 1 ? "Teduga TBC" : "Bukan Teduga TBC";
        const modalHtml = `<div style="display:flex;flex-direction:column;align-items:center;gap:8px;padding:16px">
          <div style="font-weight:700;color:var(--muted)">Kesimpulan</div>
          <div style="font-size:20px;font-weight:800;color:${
            yesCount >= 1 ? "var(--accent-2)" : "var(--accent)"
        }">${escapeHtml(conclusion)}</div>
        </div>`;
        const resultsHtml = rows
            .map(
                (r) =>
                    `<div class="kv"><div class="k">${
                        r[0]
                    }</div><div class="v">${escapeHtml(r[1])}</div></div>`
            )
            .join("");
        return { modalHtml, resultsHtml };
    }

    function escapeHtml(str) {
        if (!str && str !== 0) return "";
        return String(str)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // --------- IFRAME submission (menghindari preflight) ----------
    function submitViaIframe() {
        const data = gatherData();
        // ensure we use the same field keys as gatherData and avoid duplicate entries
        const values = [
            data.timestamp,
            document.getElementById("exam_date").value || "",
            data.name,
            data.age,
            data.weight,
            data.height,
            data.gender,
            data.phone,
            data.job,
            data.address,
            data.location,
            // Section 2 (Keluhan)
            data.cough_long,
            data.cough_short,
            data.cough_blood,
            data.fever,
            data.night_sweats,
            data.shortness_of_breath,
            data.chest_pain,
            data.lymph_swelling,
            data.appetite_loss,
            data.fatigue,
            data.weight_loss,
            // Section 3 (Informasi Lain)
            data.tb_contact,
            data.tb_close_contact,
            data.tb_household_contact,
            data.tb_treatment_complete,
            data.tb_treatment_incomplete,
            data.diabetes,
            data.hiv_status,
            data.pregnant,
            data.smoking,
            data.age_0_14,
            data.elderly_60_plus,
            data.window_ventilation,
            data.people_sleeping_per_room,
            data.damp_or_mold,
            data.indoor_smoking,
            data.no_window_sleeping,
            // legacy/optional
            data.complaint,
            data.severity,
            data.other_symptoms,
        ];
        const payload = { sheetName: sheetName, values: values };

        hiddenForm.querySelector('input[name="sheetName"]').value = sheetName;
        hiddenValuesInput.value = JSON.stringify(payload);

        const iframe = document.getElementById("gs-iframe");
        let loaded = false;
        function onLoad() {
            if (loaded) return;
            loaded = true;
            // Save last submission locally for results view and modal
            try {
                localStorage.setItem("tb_last_submission", JSON.stringify(data));
            } catch (e) {}
            // Show summary modal
            showSummaryModal(data);
            // Kirim email hanya jika terduga TBC (ada minimal 1 'Ya' di gejala)
            (function () {
                const symptomKeys = [
                    "cough_long",
                    "cough_short",
                    "cough_blood",
                    "fever",
                    "night_sweats",
                    "shortness_of_breath",
                    "chest_pain",
                    "lymph_swelling",
                    "appetite_loss",
                    "fatigue",
                    "weight_loss",
                ];
                const yesCount = symptomKeys.reduce(
                    (acc, k) => acc + (data[k] === "Ya" ? 1 : 0),
                    0
                );
                if (yesCount >= 1) {
                    try {
                        sendEmail(data);
                    } catch (e) {
                        console.warn("sendEmail failed", e);
                    }
                } else {
                    console.log("Bukan terduga TBC — email tidak dikirim");
                }
            })();
            // reset form & UI
            document.getElementById("tbForm").reset();
            document
                .querySelectorAll(".chip")
                .forEach((c) => c.classList.remove("active"));
            localStorage.removeItem("tb_form_draft");
            setExamDate();
            current = 0;
            showStep(current);
            iframe.removeEventListener("load", onLoad);
        }
        iframe.addEventListener("load", onLoad);
        hiddenForm.submit();
        showMessage(
            "Mengirim data...",
            "success"
        );
    }

    // EmailJS send
    function sendEmail(data) {
        if (typeof emailjs === "undefined") {
            console.warn("EmailJS SDK not loaded");
            return;
        }

        // Template parameters - adjust according to your EmailJS template variables
        const summaryShort = `Nama: ${data.name} | Usia: ${
            data.age
        } | Alamat: ${data.address || "-"}`;

        const serviceID = "tbpkmmulyorejo_7";
        const templateID = "template_tbc_email";

        emailjs.send(serviceID, templateID, {
            email: EMAIL_RECIPIENT,
            summary: summaryShort,
            message: "Send Email"
        })
            .then((response) => {
                console.log("EmailJS sent", response.status, response.text);
            })
            .catch((err) => {
                console.error("EmailJS error", JSON.stringify(err));
            });
    }

    // Modal handling
    function showSummaryModal(data) {
        const html = renderSummaryHTML(data);
        modalBody.innerHTML = html.modalHtml;
        modalBackdrop.style.display = "flex";
        modalBackdrop.setAttribute("aria-hidden", "false");
    }
    function hideModal() {
        modalBackdrop.style.display = "none";
        modalBackdrop.setAttribute("aria-hidden", "true");
    }

    // Results panel handling
    function showResultsPanel() {
        const raw = localStorage.getItem("tb_last_submission");
        if (!raw) {
            resultsContent.innerHTML =
                '<p class="note">Belum ada data pengisian. Isi form dan submit terlebih dahulu.</p>';
        } else {
            try {
                const obj = JSON.parse(raw);
                const html = renderSummaryHTML(obj);
                resultsContent.innerHTML = html.resultsHtml;
            } catch (e) {
                resultsContent.innerHTML =
                    '<p class="note">Gagal memuat data ringkasan.</p>';
            }
        }
        resultsPanel.style.display = "block";
        document.getElementById("tbForm").style.display = "none";
        setActiveTopAction("results");
    }
    function hideResultsPanel() {
        resultsPanel.style.display = "none";
        document.getElementById("tbForm").style.display = "";
        setActiveTopAction("form");
    }
    function setActiveTopAction(mode) {
        if (mode === "results") {
            viewResultsBtn.classList.add("active");
            viewFormBtn.classList.remove("active");
        } else {
            viewFormBtn.classList.add("active");
            viewResultsBtn.classList.remove("active");
        }
    }

    // accessibility: Enter to next (except textarea)
    document.getElementById("tbForm").addEventListener("keydown", (e) => {
        if (e.key === "Enter" && e.target.tagName !== "TEXTAREA") {
            e.preventDefault();
            btnNext.click();
        }
    });
</script>
</body>
</html>
